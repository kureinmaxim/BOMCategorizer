# Решение проблемы с отображением кириллицы в PDF

## Проблема

После установки программы на новой машине кириллица в PDF файлах отображается некорректно (квадратиками или знаками вопроса), в то время как на другой машине всё работает правильно.

## Причина

Программа использует библиотеку ReportLab для создания PDF файлов. Для корректного отображения кириллицы необходимы TrueType шрифты с поддержкой кириллических символов.

При экспорте в PDF программа пытается найти подходящие шрифты в следующем порядке:

1. **Папка приложения** (`{app}\fonts\`) - шрифты, установленные инсталлятором
2. **Системные шрифты Windows**: Arial
3. **Системные шрифты macOS**: Arial
4. **Системные DejaVu Sans** (C:/Windows/Fonts/DejaVuSans.ttf)
5. **DejaVu из пакета reportlab**
6. **Times New Roman** (Windows)
7. **Helvetica** (fallback без кириллицы) ⚠️

Если ни один из шрифтов не найден или не может быть зарегистрирован, программа использует Helvetica, который **не поддерживает кириллицу**.

## Решения

### Вариант 1: Пересборка инсталлятора со встроенными шрифтами (рекомендуется)

Это решает проблему раз и навсегда для всех пользователей.

#### Шаг 1: Скачайте шрифты DejaVu Sans

Запустите PowerShell скрипт:
```powershell
.\download_fonts.ps1
```

Или скачайте вручную:
1. Перейдите на https://dejavu-fonts.github.io/
2. Скачайте `dejavu-fonts-ttf-2.37.zip` (или последнюю версию)
3. Распакуйте архив
4. Скопируйте два файла в папку `fonts` проекта:
   - `DejaVuSans.ttf`
   - `DejaVuSans-Bold.ttf`

#### Шаг 2: Соберите инсталлятор

```bash
# Для Qt версии
python build_installer.py

# Или скомпилируйте вручную в Inno Setup Compiler
# Откройте: installer_qt.iss или installer_active.iss
```

#### Шаг 3: Установите на проблемную машину

Новый инсталлятор автоматически скопирует шрифты в папку приложения.

**Преимущества:**
- ✅ Решает проблему для всех пользователей
- ✅ Не требует прав администратора
- ✅ Работает без подключения к интернету
- ✅ Шрифты всегда доступны

**Лицензия:** DejaVu шрифты распространяются под свободной лицензией и могут быть включены в инсталлятор.

---

### Вариант 2: Ручная установка шрифтов на проблемной машине

Если вы не можете пересобрать инсталлятор, установите шрифты вручную.

#### Windows

**Способ A: Установка в систему (требует прав администратора)**

1. Скачайте https://dejavu-fonts.github.io/
2. Распакуйте архив
3. Найдите файлы:
   - `DejaVuSans.ttf`
   - `DejaVuSans-Bold.ttf`
4. Щелкните правой кнопкой → "Установить" или "Install for all users"
5. Перезапустите BOMCategorizer

**Способ B: Копирование в папку приложения (не требует прав администратора)**

1. Скачайте шрифты DejaVu Sans (см. выше)
2. Создайте папку `fonts` в установленном приложении:
   ```
   C:\Users\{ВашПользователь}\AppData\Roaming\BOMCategorizerModern\fonts\
   ```
3. Скопируйте туда файлы:
   - `DejaVuSans.ttf`
   - `DejaVuSans-Bold.ttf`
4. Перезапустите BOMCategorizer

#### macOS

```bash
# Через Homebrew
brew tap homebrew/cask-fonts
brew install --cask font-dejavu
```

Или установите вручную через Font Book.

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get install fonts-dejavu fonts-dejavu-core

# Fedora/RHEL
sudo dnf install dejavu-sans-fonts

# Arch Linux
sudo pacman -S ttf-dejavu
```

---

### Вариант 3: Установка пакета reportlab с расширенной поддержкой

```bash
pip install reportlab[rlpycairo]
```

Это может добавить дополнительные шрифты в папку reportlab.

---

## Диагностика проблемы

### Проверка доступных шрифтов

Запустите скрипт проверки:

```bash
python check_pdf_fonts.py
```

Или через bat файл:
```bash
check_pdf_fonts.bat
```

Этот скрипт покажет:
- Какие шрифты найдены в системе
- Какие шрифты успешно зарегистрированы
- Детальную диагностику проблем
- Рекомендации по установке

### Вывод при экспорте PDF

При создании PDF программа выводит в консоль информацию о зарегистрированных шрифтах:

**Успешная регистрация:**
```
✓ Зарегистрированы шрифты: DejaVuSans из папки приложения (поддержка кириллицы)
```

**Проблема:**
```
======================================================================
⚠️  ВНИМАНИЕ: Не удалось зарегистрировать шрифты с поддержкой кириллицы!
======================================================================
Кириллические символы в PDF будут отображаться некорректно (квадратиками).

Причины:
  - Arial: Файлы не найдены - ['Arial', 'Arial-Bold']
  - DejaVuSans: Папка fonts не найдена в C:\...
  ...
```

Если вы видите это предупреждение - необходимо установить шрифты.

---

## Структура проекта (для разработчиков)

```
BOMCategorizer/
├── fonts/                          # Шрифты для встраивания в инсталлятор
│   ├── README.md                   # Инструкция по получению шрифтов
│   ├── DejaVuSans.ttf             # Основной шрифт (не в Git)
│   └── DejaVuSans-Bold.ttf        # Жирный шрифт (не в Git)
├── bom_categorizer/
│   └── pdf_exporter.py            # Модуль экспорта PDF
├── check_pdf_fonts.py             # Утилита диагностики шрифтов
├── check_pdf_fonts.bat            # Bat файл для проверки
├── download_fonts.ps1             # Скрипт скачивания шрифтов
├── installer_qt.iss               # Скрипт Inno Setup (встраивает fonts/)
└── installer_active.iss           # Альтернативный инсталлятор
```

### Логика поиска шрифтов в pdf_exporter.py

```python
def _register_fonts(self):
    # Приоритет 1: Папка приложения (установлено инсталлятором)
    #   - {app}/fonts/DejaVuSans.ttf
    #   - Работает для всех пользователей после установки
    
    # Приоритет 2-3: Системные шрифты (Arial)
    #   - Windows: C:/Windows/Fonts/arial.ttf
    #   - macOS: /System/Library/Fonts/Supplemental/Arial.ttf
    
    # Приоритет 4: DejaVu в системных папках
    #   - Linux: /usr/share/fonts/truetype/dejavu/
    #   - Windows: C:/Windows/Fonts/DejaVuSans.ttf (если установлен)
    
    # Приоритет 5: DejaVu из пакета reportlab
    #   - site-packages/reportlab/fonts/
    
    # Приоритет 6: Times New Roman (Windows)
    #   - C:/Windows/Fonts/times.ttf
    
    # Fallback: Helvetica (БЕЗ кириллицы!)
    #   - Используется если ничего не найдено
    #   - Показывает квадратики вместо кириллицы
```

---

## Inno Setup конфигурация

В файлах `installer_qt.iss` и `installer_active.iss`:

```iss
[Files]
; Встраиваем шрифты из папки fonts в инсталлятор
Source: "fonts\*.ttf"; DestDir: "{app}\fonts"; Flags: ignoreversion; Check: FontsExist

[Code]
function FontsExist: Boolean;
begin
  Result := DirExists(ExpandConstant('{src}\fonts'));
end;
```

Эта конфигурация:
- Проверяет наличие папки `fonts` в исходниках
- Если папка существует и содержит .ttf файлы - включает их в инсталлятор
- При установке копирует шрифты в `{app}\fonts\`
- Не требует прав администратора

---

## Лицензия шрифтов DejaVu

DejaVu fonts лицензированы под [DejaVu Fonts License](https://dejavu-fonts.github.io/License.html), которая:

- ✅ Разрешает свободное использование
- ✅ Разрешает распространение (включая инсталляторы)
- ✅ Разрешает модификацию
- ✅ Разрешает коммерческое использование
- ℹ️ Требует сохранения уведомления об авторских правах

Вы можете безопасно включать эти шрифты в ваш инсталлятор.

---

## FAQ

**Q: Почему на одной машине работает, а на другой нет?**

A: На рабочей машине, вероятно:
- Установлен пакет reportlab с дополнительными зависимостями
- Вручную установлены шрифты DejaVu
- В системной папке Windows есть файлы arial.ttf

**Q: Можно ли использовать другие шрифты?**

A: Да, можно использовать любые TrueType шрифты с поддержкой кириллицы:
- PT Sans, PT Serif (шрифты ParaType)
- Roboto (Google Fonts)
- Open Sans
- Liberation Sans

Просто замените файлы в папке `fonts` и обновите код в `pdf_exporter.py`.

**Q: Почему шрифты не включены в Git?**

A: Файлы .ttf обычно большие (несколько МБ) и не подходят для Git. Вместо этого:
- Разработчики скачивают шрифты локально через `download_fonts.ps1`
- Инсталлятор собирается со шрифтами
- Конечные пользователи получают шрифты через инсталлятор

**Q: Нужны ли права администратора?**

A: 
- **Для установки в папку приложения**: НЕТ
- **Для установки в C:\Windows\Fonts**: ДА

Инсталлятор использует `PrivilegesRequired=lowest` и устанавливает шрифты в папку приложения.

---

## Контрольный список для разработчиков

Перед сборкой релиза:

- [ ] Скачаны шрифты: `.\download_fonts.ps1`
- [ ] Файлы существуют:
  - [ ] `fonts/DejaVuSans.ttf`
  - [ ] `fonts/DejaVuSans-Bold.ttf`
- [ ] Проверена регистрация: `python check_pdf_fonts.py`
- [ ] Собран инсталлятор: `python build_installer.py`
- [ ] Тестовая установка на чистой машине
- [ ] Создан тестовый PDF с кириллицей
- [ ] Кириллица отображается корректно ✓

---

## Дополнительные ресурсы

- [DejaVu Fonts](https://dejavu-fonts.github.io/)
- [ReportLab Documentation](https://docs.reportlab.com/)
- [Inno Setup Documentation](https://jrsoftware.org/ishelp/)
- [Google Fonts](https://fonts.google.com/) - альтернативные шрифты

